<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>营会小组看板 · 一体化</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0f1222; --card1:#161a2e; --card2:#14182b; --border:#272b45; --muted:#aab1d6; --ink:#e8ecff;
      --pill:#1a1f3b; --pill-b:#2a2f53; --btn:#253157; --btn-b:#2f3a66;
    }
    body { margin:0; background:var(--bg); color:var(--ink); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial; }
    .wrap { max-width:1000px; margin:0 auto; padding:18px; }
    .card { background:linear-gradient(180deg,var(--card1),var(--card2)); border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35); margin-top:14px; }
    h1,h2,h3 { margin:0 0 8px 0; }
    .muted { color:var(--muted); }
    .pill { display:inline-block; padding:6px 10px; border:1px solid var(--pill-b); border-radius:999px; background:var(--pill); color:#b9c2ff; font-size:12px; margin-right:8px; }
    a { color:#acd0ff; }
    .btn { display:inline-block; padding:10px 12px; border-radius:10px; background:var(--btn); border:1px solid var(--btn-b); text-decoration:none; color:#eaf1ff; font-weight:600; }
    .list { list-style:none; padding-left:0; }
    .list li { padding:6px 0; border-bottom:1px dashed var(--pill-b); }
    .imgbox { margin-top:12px; border:1px solid var(--pill-b); background:#121632; border-radius:12px; overflow:hidden; }
    .imgbox img { width:100%; height:auto; display:block; }
    table { border-collapse:collapse; width:100%; }
    th,td { border:1px solid var(--pill-b); padding:8px; vertical-align:top; }
    th { background:#1a1f3b; position:sticky; top:0; }
    .scroll { overflow:auto; }
    .topbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .kbd { padding:2px 6px; border-radius:6px; background:#1b2140; border:1px solid #2b325a; color:#c8d2ff; font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="topbar">
      <h1>营会小组看板 · 一体化</h1>
      <span class="pill">实时更新</span>
      <span class="pill">NFC 一碰即达</span>
      <span class="kbd">成员：?gid=1</span>
      <span class="kbd">百夫长：?role=centurion</span>
      <span class="kbd">同工：?role=admin</span>
    </div>
    <div id="mode" class="muted"></div>
  </div>

  <div id="content" class="card"><div class="muted">正在载入数据…</div></div>
  <div class="card"><div class="muted">提示：若信息未刷新，尝试下拉刷新或过几秒再试。</div></div>
</div>

<script>
  const API_BASE = "https://summercamp2025si.mumulinhuikai.workers.dev";

  const qs = new URLSearchParams(location.search);
  const gid  = qs.get("gid");
  const role = qs.get("role");

  const modeEl = document.getElementById("mode");
  const content = document.getElementById("content");

  function pick(obj, keys, fallback=null){
    for (const k of keys) { if (obj && obj[k]!=null && obj[k] !== "") return obj[k]; }
    return fallback;
  }
  function pickImageUrl(obj){
    const keys = ["时间表图片","时间表","图片","scheduleImage","image","海报","行程图"];
    for (const k of keys) {
      const v = obj[k];
      if (Array.isArray(v) && v.length && v[0]?.file?.url) return v[0].file.url;
      if (typeof v === "string" && v) return v;
    }
    return null;
  }

  async function run(){
    try {
      if (gid) {
        modeEl.textContent = "模式：成员视图（单组） · gid=" + gid;
        const r = await fetch(API_BASE + "/?gid=" + encodeURIComponent(gid));
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || "加载失败");

        const name        = pick(j, ["groupName","组名","名称"], "未命名小组");
        const leaders     = pick(j, ["leaders","带领","负责人"], "—");
        const membersText = pick(j, ["members","成员名单","成员"], "");
        const points      = pick(j, ["points","积分"], 0);
        const announcement= pick(j, ["announcement","公告"], "");
        const resources   = pick(j, ["resourcesLink","资源链接","链接"], null);
        const imgUrl      = pickImageUrl(j);
        const members = String(membersText).split(",").map(s=>s.trim()).filter(Boolean);

        content.innerHTML = `
          <h2 style="margin-top:0">${name}</h2>
          <p class="muted">带领：${leaders} · 积分：${points}</p>
          ${announcement ? `<p>公告：${announcement}</p>` : ""}
          ${members.length ? `<h3>成员</h3><ul class="list">${members.map(m=>`<li>${m}</li>`).join("")}</ul>` : ""}
          ${imgUrl ? `<div class="imgbox"><img src="${imgUrl}" alt="时间表图片"></div>` : ""}
          ${resources ? `<p><a class="btn" href="${resources}" target="_blank" rel="noopener">资料与链接</a></p>` : ""}
          <p class="muted" style="font-size:12px">最后更新：${new Date(j.lastEditedTime).toLocaleString()}</p>
        `;
        return;
      }

      // 全部/百夫长视图
      let api = API_BASE + "/";
      if (role) api += "?role=" + encodeURIComponent(role);
      modeEl.textContent = "模式：" + (role==="admin" ? "同工总览（全部）" : role==="centurion" ? "百夫长总览（限定）" : "总览（未授权可能返回 403）");

      const r = await fetch(api);
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || "加载失败");
      if (!Array.isArray(data)) throw new Error("返回不是列表");

      const allKeys = new Set();
      data.forEach(row => Object.keys(row).forEach(k => allKeys.add(k)));
      const headers = Array.from(allKeys);

      let html = "<div class='scroll'><table><thead><tr>";
      headers.forEach(h => html += `<th>${escapeHtml(h)}</th>`);
      html += "</tr></thead><tbody>";
      data.forEach(row => {
        html += "<tr>";
        headers.forEach(h => html += `<td>${formatValue(row[h])}</td>`);
        html += "</tr>";
      });
      html += "</tbody></table></div>";
      content.innerHTML = html;

    } catch(e) {
      content.innerHTML = `<p>载入失败：${e.message}</p>`;
    }
  }

  function formatValue(v){
    if (Array.isArray(v) && v.length && v[0]?.file?.url) return `<img src="${escapeAttr(v[0].file.url)}" alt="图片" style="max-width:140px">`;
    if (typeof v === "string" && /\.(jpg|jpeg|png|gif|webp)$/i.test(v)) return `<img src="${escapeAttr(v)}" alt="图片" style="max-width:140px">`;
    if (typeof v === "string" && /^https?:\/\//i.test(v)) { const t = v.length>60 ? v.slice(0,57)+"..." : v; return `<a href="${escapeAttr(v)}" target="_blank" rel="noopener">${escapeHtml(t)}</a>`; }
    if (Array.isArray(v)) return escapeHtml(v.join(", "));
    if (typeof v === "object" && v!==null) return `<pre>${escapeHtml(JSON.stringify(v,null,2))}</pre>`;
    return v==null ? "" : escapeHtml(String(v));
  }
  function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
  function escapeAttr(s){ return String(s).replaceAll('"',"&quot;"); }

  run();
</script>
</body>
</html>
